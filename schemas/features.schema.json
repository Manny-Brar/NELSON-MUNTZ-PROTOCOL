{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ralph-wiggum.claude.dev/schemas/features.schema.json",
  "title": "Ralph v3.0 Features Schema",
  "description": "Schema for structured feature tracking in Ralph v3.0 loops. JSON format chosen because models are less likely to corrupt JSON compared to Markdown.",
  "type": "object",
  "required": ["version", "features", "summary"],
  "properties": {
    "version": {
      "type": "string",
      "const": "3.0.0",
      "description": "Schema version for compatibility checking"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "When the feature list was created"
    },
    "last_updated": {
      "type": "string",
      "format": "date-time",
      "description": "Last modification timestamp"
    },
    "original_prompt": {
      "type": "string",
      "description": "The original task prompt for reference"
    },
    "features": {
      "type": "array",
      "description": "List of features to implement",
      "items": {
        "type": "object",
        "required": ["id", "description", "passes", "attempts", "max_attempts", "priority"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^F[0-9]+$",
            "description": "Feature ID (e.g., F1, F2, F3)"
          },
          "description": {
            "type": "string",
            "minLength": 10,
            "description": "Clear description of what this feature does"
          },
          "steps": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Ordered steps to implement this feature"
          },
          "verification": {
            "type": "string",
            "description": "Command to verify feature works (e.g., 'npm run test:auth')"
          },
          "passes": {
            "type": "boolean",
            "default": false,
            "description": "Whether feature has passed both spec and quality validation"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "completed", "blocked"],
            "default": "pending",
            "description": "Current status of the feature"
          },
          "priority": {
            "type": "integer",
            "minimum": 1,
            "description": "Priority order (1 = highest priority, implement first)"
          },
          "attempts": {
            "type": "integer",
            "minimum": 0,
            "default": 0,
            "description": "Number of iterations that have attempted this feature"
          },
          "max_attempts": {
            "type": "integer",
            "minimum": 1,
            "default": 3,
            "description": "Maximum attempts before marking as blocked (3-fix rule)"
          },
          "blocked_by": {
            "type": "array",
            "items": {"type": "string"},
            "description": "IDs of features that must complete first (e.g., ['F1', 'F2'])"
          },
          "blocked_reason": {
            "type": "string",
            "description": "Explanation of why feature is blocked (if status is 'blocked')"
          },
          "started_at": {
            "type": "string",
            "format": "date-time",
            "description": "When work on this feature began"
          },
          "completed_at": {
            "type": "string",
            "format": "date-time",
            "description": "When feature was completed or blocked"
          },
          "notes": {
            "type": "string",
            "description": "Additional notes about implementation"
          }
        }
      }
    },
    "summary": {
      "type": "object",
      "required": ["total", "completed", "blocked", "in_progress", "pending"],
      "description": "Summary counts for quick status check",
      "properties": {
        "total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of features"
        },
        "completed": {
          "type": "integer",
          "minimum": 0,
          "description": "Features with passes: true"
        },
        "blocked": {
          "type": "integer",
          "minimum": 0,
          "description": "Features marked as blocked"
        },
        "in_progress": {
          "type": "integer",
          "minimum": 0,
          "description": "Features currently being worked on"
        },
        "pending": {
          "type": "integer",
          "minimum": 0,
          "description": "Features not yet started"
        }
      }
    },
    "completion_criteria": {
      "type": "object",
      "description": "Conditions for loop completion",
      "properties": {
        "all_features_pass": {
          "type": "boolean",
          "description": "True when all non-blocked features pass"
        },
        "completion_promise": {
          "type": "string",
          "description": "The promise phrase that signals completion"
        },
        "minimum_features": {
          "type": "integer",
          "description": "Minimum features that must pass for completion"
        }
      }
    }
  },
  "examples": [
    {
      "version": "3.0.0",
      "created_at": "2026-01-13T00:00:00Z",
      "last_updated": "2026-01-13T00:00:00Z",
      "original_prompt": "Build a REST API with authentication",
      "features": [
        {
          "id": "F1",
          "description": "Create user registration endpoint with validation",
          "steps": [
            "Create POST /api/users endpoint",
            "Add input validation",
            "Hash password before storage",
            "Return JWT token on success"
          ],
          "verification": "npm run test:auth",
          "passes": false,
          "status": "pending",
          "priority": 1,
          "attempts": 0,
          "max_attempts": 3,
          "blocked_by": []
        },
        {
          "id": "F2",
          "description": "Create login endpoint with JWT generation",
          "steps": [
            "Create POST /api/login endpoint",
            "Verify credentials",
            "Generate JWT token",
            "Return token and user info"
          ],
          "verification": "npm run test:login",
          "passes": false,
          "status": "pending",
          "priority": 2,
          "attempts": 0,
          "max_attempts": 3,
          "blocked_by": ["F1"]
        }
      ],
      "summary": {
        "total": 2,
        "completed": 0,
        "blocked": 0,
        "in_progress": 0,
        "pending": 2
      },
      "completion_criteria": {
        "all_features_pass": false,
        "completion_promise": "ALL FEATURES COMPLETE",
        "minimum_features": 2
      }
    }
  ]
}
